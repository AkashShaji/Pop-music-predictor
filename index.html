<!DOCTYPE html>
<html>
<head>
  <title>Spotify Web Playback SDK Quick Start Tutorial</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

</head>
<body style="background-color: #A1BAD1">
  <div>
    <center><h1>Will the current song be a hit????</h1>
    <button type="button" class="btn btn-primary" onclick = "doThing()">Find</button></center><br/>
    <div style="padding-left:5%;padding-right:5%;">
        <div>
          <h1 id="key"></h1>
          <h1 id="result"></h1>
        </div>
        <div class ="energy progress-bar" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="width:50%">
            <span style="position: relative;">energy</span>
        </div><br/>
        <div class ="danceability progress-bar" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="width:50%">
            danceability
        </div><br/>
        <div class ="valence progress-bar" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="width:50%">
            positivity
        </div><br/> 
  </div>
  <div class="form-group" style="padding-left:5%;padding-right:5%;">
    <label for="authInput">Auth Code</label>
    <input type="auth" class="form-control" id="token_input" aria-describedby="emailHelp">
    <small id="emailHelp" class="form-text text-muted">Get your authorization code <a href = "https://beta.developer.spotify.com/console/get-users-currently-playing-track/" target = "_blank"> here </a> </small>
  </div>
    <button  value="Submit" onclick="updateToken()" class="btn btn-primary">Submit</button>



  <script>
  token = ""
  function doThing(){
     $.ajax({
        url: "  https://api.spotify.com/v1/me/player",
        beforeSend: function(xhr) {
             xhr.setRequestHeader("Authorization", "Bearer " + token)
        }, success: function(data){
          $.ajax({
            url: "https://api.spotify.com/v1/audio-features/" + data['item']['id'],
            beforeSend: function(xhr) {
                 xhr.setRequestHeader("Authorization", "Bearer " + token)
            }, success: function(data2){
              updateData(data, data2)
              if(isInInterval("danceability", 0.1329, 0.661, data2)){
                $("#result").html("Sounds like a hit!")
              }else{
                $("#result").html("Not a hit")
              }
            }
          })
        }
      })
   }
   function updateToken(){
    token = $("#token_input").val()
    console.log(token)
   }

   function isInInterval(attr, std, avg, data){
    alert((data[attr] > avg - ((std/19.4679223339)*1.645)) && (data[attr] < avg + ((std/19.4679223339)*1.645)))
    console.log(avg - ((std/19.4679223339)*1.645))
    console.log(avg + ((std/19.4679223339)*1.645))
    console.log(data[attr])
    return (data[attr] > avg - ((std/19.4679223339)*1.645)) && (data[attr] < avg + ((std/19.4679223339)*1.645))
   }

   function updateData(data, data2){
      var key = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"]
      $("#key").html(data['item']['name'] + ", by " + data['item']['artists'][0]['name'] + " is in the key of " + key[data2['key']])
      $(".energy").attr("aria-valuenow", data2['energy'] * 100)
      $(".energy").attr("style", "width:" + data2['energy'] * 100 + "%")
      $(".energy").html("energy - " + data2['energy'] * 100 + "%")

      $(".danceability").attr("aria-valuenow", data2['danceability'] * 100)
      $(".danceability").attr("style", "width:" + data2['danceability'] * 100 + "%")
      $(".danceability").html("danceability - " + data2['danceability'] * 100 + "%")

      $(".valence").attr("aria-valuenow", data2['valence'] * 100)
      $(".valence").attr("style", "width:" + data2['valence'] * 100 + "%")
      $(".valence").html("positivity - " + data2['valence'] * 100 + "%")


      if(data2['energy'] >= 0.7){
        $(".energy").attr("class", "energy progress-bar progress-bar-success")
      }else if(data2['energy'] >= 0.3){
        $(".energy").attr("class", "energy progress-bar")
      }else{
        $(".energy").attr("class", "energy progress-bar progress-bar-danger")
      }
      if(data2['danceability'] >= 0.7){
        $(".danceability").attr("class", "danceability progress-bar progress-bar-success")
      }else if(data2['energy'] >= 0.3){
        $(".danceability").attr("class", "danceability progress-bar")
      }else{
        $(".danceability").attr("class", "danceability progress-bar progress-bar-danger")
      }
      if(data2['valence'] >= 0.7){
        $(".valence").attr("class", "valence progress-bar progress-bar-success")
      }else if(data2['energy'] >= 0.3){
        $(".valence").attr("class", "valence progress-bar")
      }else{
        $(".valence").attr("class", "valence progress-bar progress-bar-danger")
      }
   }
  </script>

</body>
</html>
